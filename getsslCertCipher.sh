#! /bin/bash
#現状ipでしか入力できないよう制限してる
manualProc() {
echo "Input IP,Port   [ip] [port]";

##IP:Port手入力プロセス
read ip port 
if [[ "$ip" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3} ]]; then
    if [[ "$port" =~ ^[0-9]+ ]]; then
        execSslCmd $ip $port;       
    else
        echo "Incorrect Format -> [ip] [port]"
        echo "ip=>$ip port=>$port"
        manualProc
    fi
else
    echo Incorrect Format
    manualProc
fi
echo finished!

}

## バッチ処理
#$1:file name
batchProc() {

#Check Exist
if [ ! -e $1 ];then
  echo file dose not exist.;
  exit;
fi

while read ip port
do
#Check Format
    if [[ "$ip" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3} ]]; then
        if [[ "$port" =~ ^[0-9]+ ]]; then
            echo Batch start!...
            execSslCmd $ip $port;       
            echo $ip $port        
        else
            echo "Incorrect Format -> [ip] [port]"
            echo "ip=>$ip  port=>$port"
            exit;
        fi
    else
        echo "Incorrect Format -> [ip] [port]"
        echo "ip=>$ip  port=>$port"
        exit;
    fi
    
done < $1
}

#I'd like to Putting port Num to fileName
#$1:ip address
#$2:port
execSslCmd() {

fname=`date +"%Y%m%d"`_$1
# echo "======NSE start======" >> $fname\_sslCipher.txt;
# nmap -sV -p $2 -v -Pn --script ssl-ccs-injection,ssl-cert,ssl-date,ssl-dh-params,ssl-enum-ciphers,ssl-google-cert-catalog,ssl-heartbleed,ssl-known-key,ssl-poodle,sslv2 --script-args vulns.showall $1 >> $fname\_sslCipher.txt;

# echo "===openssl showcerts start===" >> $fname\_certificate.txt;
# openssl s_client -connect $1 -showcerts < /dev/null 
# # openssl s_client -connect $1 -showcerts < /dev/null >> $fname\_certificate.txt;

#macのopensslだと Not Found と言われ動かない
echo "===openssl x509 start===" >> $fname\_certificate.txt;
echo $1 $2
openssl s_client -connect $1:$2 < /dev/null 2>/dev/null　|　openssl x509 -text
# openssl s_client -connect $1 < /dev/null 2>/dev/null|openssl x509 -text >> $fname\_certificate.txt;

# echo "===sslscan start===" >> $fname\_sslCipher.txt;
# sslscan --no-colour $1 >> $fname\_sslCipher.txt;
}

select option in Manual batch
do
    echo "you press $option";

    if [ $option = "Manual" ]; then
        manualProc
        break;
    elif [ $option = "batch" ]; then
        echo "Specify the file.  -> Format Line \"[ip]\s[port]\n\""
        read fname
        batchProc $fname
        break;
    else
        echo "Please press 1) or 2)";
    fi
done